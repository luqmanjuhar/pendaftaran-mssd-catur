<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Sukan Catur MSSD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .registration-tab-content {
            display: block;
        }
        
        .registration-tab-content.hidden {
            display: none;
        }

        

    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-orange-50 to-orange-100 min-h-full">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
   <header class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h1 class="text-3xl font-bold text-orange-600 text-center">Dashboard Sukan Catur MSSD</h1>
    <p class="text-center text-gray-600 mt-2">Sistem Pendaftaran Kejohanan Catur Peringkat Daerah</p>
   </header>
   <nav class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="flex flex-wrap gap-3 justify-center"><button onclick="switchTab('pendaftaran')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-orange-600 text-white" data-tab="pendaftaran"> ğŸ“ Pendaftaran </button> <button onclick="switchTab('dashboard')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="dashboard"> ğŸ“Š Dashboard Pendaftaran </button> <button onclick="switchTab('pengumuman')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="pengumuman"> ğŸ“¢ Pengumuman </button> <button onclick="switchTab('dokumen')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="dokumen"> ğŸ“„ Dokumen Tambahan </button>
    </div>
   </nav>
   <div id="pendaftaran" class="tab-content active">
    <div class="bg-white rounded-lg shadow-lg p-6">
     <h2 class="text-2xl font-bold text-orange-600 mb-6">Pendaftaran</h2><!-- Sub Navigation -->
     <div class="flex gap-4 mb-6 border-b border-gray-200"><button onclick="switchRegistrationTab('daftar-baru')" class="registration-tab-btn px-4 py-2 font-semibold border-b-2 border-orange-600 text-orange-600" data-reg-tab="daftar-baru"> â• Daftar Baru </button> <button onclick="switchRegistrationTab('kemaskini')" class="registration-tab-btn px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-reg-tab="kemaskini"> âœï¸ Kemaskini Pendaftaran </button>
     </div><!-- New Registration Form -->
     <div id="daftar-baru" class="registration-tab-content">
      <h3 class="text-xl font-semibold text-orange-600 mb-4">Pendaftaran Baru</h3>
      <form id="registrationForm" onsubmit="handleSubmit(event)">
       <section class="mb-8">
        <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Sekolah</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
         <div><label for="schoolName" class="block text-gray-700 font-medium mb-2">Nama Sekolah *</label> <input type="text" id="schoolName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Contoh: SK Taman Desa">
         </div>
         <div><label for="schoolType" class="block text-gray-700 font-medium mb-2">Jenis Sekolah *</label> <select id="schoolType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"> <option value="">Pilih Jenis Sekolah</option> <option value="Sekolah Kebangsaan">Sekolah Kebangsaan</option> <option value="Sekolah Menengah">Sekolah Menengah</option> </select>
         </div>
        </div>
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
         <p class="text-sm text-blue-800"><span class="font-semibold">ğŸ’¡ Tips:</span> Anda boleh gunakan singkatan sahaja:</p>
         <div class="text-xs text-blue-700 mt-1 grid grid-cols-2 gap-2">
          <div>
           â€¢ <strong>SK</strong> - Sekolah Kebangsaan
          </div>
          <div>
           â€¢ <strong>SMK</strong> - Sekolah Menengah Kebangsaan
          </div>
          <div>
           â€¢ <strong>SJKC</strong> - Sekolah Jenis Kebangsaan (Cina)
          </div>
          <div>
           â€¢ <strong>SJKT</strong> - Sekolah Jenis Kebangsaan (Tamil)
          </div>
          <div>
           â€¢ <strong>SMKA</strong> - Sekolah Menengah Kebangsaan Agama
          </div>
         </div>
        </div>
       </section>
       <section class="mb-8">
        <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Guru</h3>
        <div id="teachersContainer">
         <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="0">
          <div class="flex justify-between items-center mb-3">
           <h4 class="font-semibold text-orange-700">Guru 1 (Ketua) *</h4>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div><label class="block text-gray-700 font-medium mb-2">Nama Guru *</label> <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
           </div>
           <div><label class="block text-gray-700 font-medium mb-2">Email Guru *</label> <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
           </div>
           <div><label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label> <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
           </div>
          </div>
         </div>
        </div><button type="button" onclick="addTeacher()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> â• Tambah Guru Pengiring (Pilihan) </button>
        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
         <p class="text-sm text-blue-800"><span class="font-semibold">ğŸ’¡ Nota:</span> Guru 1 (Ketua) adalah wajib. Guru pengiring adalah pilihan dan boleh ditambah mengikut keperluan.</p>
        </div>
       </section>
       <section class="mb-8">
        <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Pendaftaran Pelajar</h3>
        <div id="studentsContainer">
         <div class="student-entry bg-orange-50 p-4 rounded-lg mb-4" data-student-index="0">
          <div class="flex justify-between items-center mb-3">
           <h4 class="font-semibold text-orange-700">Pelajar 1</h4><button type="button" onclick="removeStudent(0)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm"> ğŸ—‘ï¸ Buang </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
           <div><label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label> <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
           </div>
           <div><label class="block text-gray-700 font-medium mb-2">Nombor IC *</label> <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
           </div>
           <div><label class="block text-gray-700 font-medium mb-2">Bangsa *</label> <select required class="student-race w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"> <option value="">Pilih Bangsa</option> <option value="Melayu">Melayu</option> <option value="Cina">Cina</option> <option value="India">India</option> <option value="Bumiputera">Bumiputera</option> <option value="Lain-lain">Lain-lain</option> </select>
           </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div><label class="block text-gray-700 font-medium mb-2">Jantina *</label> <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"> <option value="">Pilih Jantina</option> <option value="Lelaki">Lelaki</option> <option value="Perempuan">Perempuan</option> </select>
           </div>
           <div><label class="block text-gray-700 font-medium mb-2">Kategori *</label> <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"> <option value="">Pilih Kategori</option> <option value="Bawah 12 Tahun">Bawah 12 Tahun</option> <option value="Bawah 15 Tahun">Bawah 15 Tahun</option> <option value="Bawah 18 Tahun">Bawah 18 Tahun</option> </select>
           </div>
           <div><label class="block text-gray-700 font-medium mb-2">ID Pemain</label> <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
           </div>
          </div>
         </div>
        </div><button type="button" onclick="addStudent()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> â• Tambah Pelajar </button>
       </section>
       <div class="flex gap-4 justify-end"><button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"> ğŸ”„ Reset </button> <button type="submit" id="submitButton" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> ğŸ’¾ Hantar Pendaftaran </button>
       </div>
      </form>
     </div><!-- Update Registration Form -->
     <div id="kemaskini" class="registration-tab-content hidden">
      <h3 class="text-xl font-semibold text-orange-600 mb-4">Kemaskini Pendaftaran</h3><!-- Search Form -->
      <div id="searchForm" class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
       <h4 class="text-lg font-semibold text-blue-800 mb-4">ğŸ” Cari Pendaftaran</h4>
       <form onsubmit="searchRegistration(event)">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
         <div><label for="searchRegId" class="block text-gray-700 font-medium mb-2">ID Pendaftaran *</label> <input type="text" id="searchRegId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contoh: MSSD-01-01">
         </div>
         <div><label for="searchPassword" class="block text-gray-700 font-medium mb-2">4 Digit Akhir No. Telefon Guru (Ketua) *</label> <input type="text" id="searchPassword" required maxlength="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 1234">
         </div>
        </div>
        <div class="flex gap-3"><button type="submit" id="searchButton" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"> ğŸ” Cari Pendaftaran </button> <button type="button" onclick="clearSearch()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"> ğŸ”„ Reset </button>
        </div>
       </form>
       <div class="mt-4 p-3 bg-blue-100 border border-blue-300 rounded-lg">
        <p class="text-sm text-blue-800"><span class="font-semibold">ğŸ’¡ Nota:</span> Masukkan ID pendaftaran yang betul dan 4 digit akhir nombor telefon guru ketua untuk akses kemaskini.</p>
       </div>
      </div><!-- Edit Form (Hidden initially) -->
      <div id="editForm" class="hidden">
       <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <h4 class="text-lg font-semibold text-green-800 mb-2">âœ… Pendaftaran Dijumpai</h4>
        <p class="text-sm text-green-700">Anda boleh mengedit maklumat di bawah dan simpan perubahan.</p>
       </div>
       <form id="updateRegistrationForm" onsubmit="handleUpdateSubmit(event)"><input type="hidden" id="editRegId" value=""> <input type="hidden" id="originalCreatedAt" value="">
        <section class="mb-8">
         <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Sekolah</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div><label for="editSchoolName" class="block text-gray-700 font-medium mb-2">Nama Sekolah *</label> <input type="text" id="editSchoolName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Contoh: SK Taman Desa">
          </div>
          <div><label for="editSchoolType" class="block text-gray-700 font-medium mb-2">Jenis Sekolah *</label> <select id="editSchoolType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"> <option value="">Pilih Jenis Sekolah</option> <option value="Sekolah Kebangsaan">Sekolah Kebangsaan</option> <option value="Sekolah Menengah">Sekolah Menengah</option> </select>
          </div>
         </div>
        </section>
        <section class="mb-8">
         <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Guru</h3>
         <div id="editTeachersContainer"><!-- Teachers will be populated here -->
         </div><button type="button" onclick="addEditTeacher()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> â• Tambah Guru Pengiring </button>
        </section>
        <section class="mb-8">
         <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Pendaftaran Pelajar</h3>
         <div id="editStudentsContainer"><!-- Students will be populated here -->
         </div><button type="button" onclick="addEditStudent()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> â• Tambah Pelajar </button>
        </section>
        <div class="flex gap-4 justify-end"><button type="button" onclick="cancelEdit()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"> âŒ Batal </button> <button type="submit" id="updateSubmitButton" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"> ğŸ’¾ Simpan Kemaskini </button>
        </div>
       </form>
      </div>
     </div>
    </div>
   </div>
   <div id="pengumuman" class="tab-content">
    <div class="bg-white rounded-lg shadow-lg p-6">
     <h2 class="text-2xl font-bold text-orange-600 mb-6">ğŸ“¢ Pengumuman Kejohanan</h2><!-- Schedule Section -->
     <div class="mb-8">
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-6 mb-6">
       <h3 class="text-xl font-bold mb-4">ğŸ“… Jadual Pertandingan</h3>
       <div class="text-center mb-4">
        <h4 class="text-lg font-semibold">KEJOHANAN CATUR MSSD KOTA TINGGI 2025</h4>
        <p class="text-blue-100">Tempat: Dewan SMK TUN HABAB</p>
       </div>
      </div><!-- Primary School Schedule -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6"><button onclick="toggleSchedule('primary')" class="w-full text-left hover:bg-green-100 transition-colors rounded-lg p-2 -m-2">
        <div class="flex justify-between items-center">
         <h4 class="text-lg font-bold text-green-800">ğŸ« SEKOLAH RENDAH (L/P 12)</h4><span id="primaryArrow" class="text-green-600 font-bold text-xl">â–¼</span>
        </div></button>
       <div id="primarySchedule" class="hidden mt-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Day 1 -->
         <div class="bg-white rounded-lg p-4 border border-green-300 shadow-sm">
          <h5 class="font-bold text-green-700 mb-4 text-center bg-green-100 py-2 rounded-lg">ğŸ“… 21 APRIL 2025 (ISNIN)</h5>
          <div class="overflow-x-auto">
           <table class="w-full text-sm">
            <thead>
             <tr class="bg-green-50">
              <th class="text-left py-2 px-3 font-semibold text-green-800 border-b">â° Masa</th>
              <th class="text-left py-2 px-3 font-semibold text-green-800 border-b">ğŸ“‹ Aktiviti</th>
             </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">7.00 - 8.00 pagi</td>
              <td class="py-2 px-3">Pendaftaran kontinjen</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">8.30 pagi</td>
              <td class="py-2 px-3">Taklimat pengurus, pengadil</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">8.45 pagi</td>
              <td class="py-2 px-3">Taklimat kepada pemain</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">9.00 â€“ 10.00 pagi</td>
              <td class="py-2 px-3 font-semibold">ï¿½ï¿½ Pusingan 1</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">10.15 pagi</td>
              <td class="py-2 px-3">Pemasangan Pusingan 2</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">10.30 â€“ 11.30 pagi</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 2</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-blue-50">
              <td class="py-2 px-3 font-medium text-gray-600">12.00 ï¿½ï¿½ï¿½ 2.00 ptg</td>
              <td class="py-2 px-3 text-gray-600">â˜• Rehat</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">2.00 â€“ 3.00 ptg</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 3</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">3.15 ptg</td>
              <td class="py-2 px-3">Pemasangan pusingan 4</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">3.30 â€“ 4.30 ptg</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 4</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div><!-- Day 2 -->
         <div class="bg-white rounded-lg p-4 border border-green-300 shadow-sm">
          <h5 class="font-bold text-green-700 mb-4 text-center bg-green-100 py-2 rounded-lg">ğŸ“… 22 APRIL 2025 (SELASA)</h5>
          <div class="overflow-x-auto">
           <table class="w-full text-sm">
            <thead>
             <tr class="bg-green-50">
              <th class="text-left py-2 px-3 font-semibold text-green-800 border-b">â° Masa</th>
              <th class="text-left py-2 px-3 font-semibold text-green-800 border-b">ğŸ“‹ Aktiviti</th>
             </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">8.00 â€“ 9.00 pagi</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 5</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">9.15 pagi</td>
              <td class="py-2 px-3">Pemasangan Pusingan 6</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">9.30 â€“ 10.30 pagi</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 6</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">10.45 pagi</td>
              <td class="py-2 px-3">Pemasangan Pusingan 7</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">11.00 â€“ 12.00 tgh</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 7</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-blue-50">
              <td class="py-2 px-3 font-medium text-gray-600">12.00 â€“ 2.00 ptg</td>
              <td class="py-2 px-3 text-gray-600">â˜• Rehat</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">2.00 â€“ 3.00 ptg</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 8</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-red-50">
              <td class="py-2 px-3 font-bold text-red-700">3.15 petang</td>
              <td class="py-2 px-3 font-semibold">ğŸ† Majlis Penutup</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div>
        </div>
        <div class="text-center mt-4 p-3 bg-green-100 rounded-lg">
         <p class="text-green-700 text-sm italic">âš ï¸ Jadual tertakluk kepada pindaan, berdasarkan keadaan.</p>
        </div>
       </div>
      </div><!-- Secondary School Schedule -->
      <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6"><button onclick="toggleSchedule('secondary')" class="w-full text-left hover:bg-purple-100 transition-colors rounded-lg p-2 -m-2">
        <div class="flex justify-between items-center">
         <h4 class="text-lg font-bold text-purple-800">ï¿½ï¿½ï¿½ SEKOLAH MENENGAH (L/P 15/18)</h4><span id="secondaryArrow" class="text-purple-600 font-bold text-xl">â–¼</span>
        </div></button>
       <div id="secondarySchedule" class="hidden mt-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Day 1 -->
         <div class="bg-white rounded-lg p-4 border border-purple-300 shadow-sm">
          <h5 class="font-bold text-purple-700 mb-4 text-center bg-purple-100 py-2 rounded-lg">ğŸ“… 23 APRIL 2025 (RABU)</h5>
          <div class="overflow-x-auto">
           <table class="w-full text-sm">
            <thead>
             <tr class="bg-purple-50">
              <th class="text-left py-2 px-3 font-semibold text-purple-800 border-b">â° Masa</th>
              <th class="text-left py-2 px-3 font-semibold text-purple-800 border-b">ğŸ“‹ Aktiviti</th>
             </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">7.00 - 8.00 pagi</td>
              <td class="py-2 px-3">Pendaftaran kontinjen</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">8.30 pagi</td>
              <td class="py-2 px-3">Taklimat pengurus, pengadil</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">8.45 pagi</td>
              <td class="py-2 px-3">Taklimat kepada pemain</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">9.00 â€“ 10.00 pagi</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 1</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">10.15 pagi</td>
              <td class="py-2 px-3">Pemasangan Pusingan 2</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">10.30 â€“ 11.30 pagi</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 2</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-blue-50">
              <td class="py-2 px-3 font-medium text-gray-600">12.00 â€“ 2.00 ptg</td>
              <td class="py-2 px-3 text-gray-600">â˜• Rehat</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">2.00 â€“ 3.00 ptg</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 3</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-green-50">
              <td class="py-2 px-3 font-medium text-green-700">4.00 ptg</td>
              <td class="py-2 px-3 font-medium">âš¡ Catur Blitz (pegawai)</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div><!-- Day 2 -->
         <div class="bg-white rounded-lg p-4 border border-purple-300 shadow-sm">
          <h5 class="font-bold text-purple-700 mb-4 text-center bg-purple-100 py-2 rounded-lg">ğŸ“… 24 APRIL 2025 (KHAMIS)</h5>
          <div class="overflow-x-auto">
           <table class="w-full text-sm">
            <thead>
             <tr class="bg-purple-50">
              <th class="text-left py-2 px-3 font-semibold text-purple-800 border-b">â° Masa</th>
              <th class="text-left py-2 px-3 font-semibold text-purple-800 border-b">ğŸ“‹ Aktiviti</th>
             </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">8.00 â€“ 9.00 pagi</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 4</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">9.15 pagi</td>
              <td class="py-2 px-3">Pemasangan Pusingan 5</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">9.30 â€“ 10.30 pagi</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 5</td>
             </tr>
             <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium text-blue-700">10.45 pagi</td>
              <td class="py-2 px-3">Pemasangan Pusingan 6</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">11.00 â€“ 12.00 tgh</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 6</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-blue-50">
              <td class="py-2 px-3 font-medium text-gray-600">12.00 â€“ 2.00 ptg</td>
              <td class="py-2 px-3 text-gray-600">â˜• Rehat</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-yellow-50">
              <td class="py-2 px-3 font-bold text-orange-700">2.00 â€“ 3.00 ptg</td>
              <td class="py-2 px-3 font-semibold">ğŸ Pusingan 7</td>
             </tr>
             <tr class="hover:bg-gray-50 bg-red-50">
              <td class="py-2 px-3 font-bold text-red-700">3.15 petang</td>
              <td class="py-2 px-3 font-semibold">ğŸ† Majlis Penutup</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div>
        </div>
        <div class="text-center mt-4 p-3 bg-purple-100 rounded-lg">
         <p class="text-purple-700 text-sm italic">âš ï¸ Jadual tertakluk kepada pindaan, berdasarkan keadaan.</p>
        </div>
       </div>
      </div>
     </div><!-- Rules, Images and Results Section -->
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6"><!-- Rules -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
       <h3 class="text-lg font-bold text-yellow-800 mb-4">ğŸ“‹ Peraturan Pertandingan</h3>
       <div class="text-center">
        <p class="text-gray-700 mb-4">Sila rujuk peraturan lengkap pertandingan melalui pautan di bawah:</p><a href="https://drive.google.com/drive/folders/1234567890" target="_blank" rel="noopener noreferrer" class="inline-block px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium"> ğŸ“– Muat Turun Peraturan </a>
       </div>
      </div><!-- Chess Results -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-6">
       <h3 class="text-lg font-bold text-green-800 mb-4">ğŸ† Keputusan Catur</h3>
       <div class="text-center">
        <p class="text-gray-700 mb-4">Lihat keputusan terkini dan kedudukan pemain:</p><a href="https://chess-results.com/tnr1008926.aspx?lan=1" target="_blank" rel="noopener noreferrer" class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"> ğŸ… Lihat Keputusan </a>
       </div>
      </div><!-- Images -->
      <div class="bg-red-50 border border-red-200 rounded-lg p-6">
       <h3 class="text-lg font-bold text-red-800 mb-4">ğŸ–¼ï¸ Gambar &amp; Media</h3>
       <div class="text-center">
        <p class="text-gray-700 mb-4">Koleksi gambar dan media berkaitan kejohanan:</p><a href="https://drive.google.com/drive/folders/0987654321" target="_blank" rel="noopener noreferrer" class="inline-block px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"> ğŸ“¸ Lihat Gambar </a>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div id="dokumen" class="tab-content">
    <div class="bg-white rounded-lg shadow-lg p-6">
     <h2 class="text-2xl font-bold text-orange-600 mb-6">ğŸ“„ Dokumen Tambahan</h2>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6"><!-- Surat Jemputan -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
       <div class="text-4xl mb-4">
        ğŸ“¨
       </div>
       <h3 class="text-lg font-bold text-blue-800 mb-3">Surat Jemputan</h3>
       <p class="text-gray-700 text-sm mb-4">Surat rasmi jemputan untuk kejohanan catur MSSD</p><a href="https://drive.google.com/file/d/1abcdefghijklmnop/view" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"> ğŸ“¥ Muat Turun </a>
      </div><!-- Surat Mesyuarat -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
       <div class="text-4xl mb-4">
        ğŸ‘¥
       </div>
       <h3 class="text-lg font-bold text-green-800 mb-3">Surat Mesyuarat Pengurus Pasukan</h3>
       <p class="text-gray-700 text-sm mb-4">Notis mesyuarat untuk pengurus dan guru pengiring</p><a href="https://drive.google.com/file/d/2bcdefghijklmnopq/view" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-sm"> ğŸ“¥ Muat Turun </a>
      </div><!-- Surat Lantikan Arbiter -->
      <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 text-center">
       <div class="text-4xl mb-4">
        âš–ï¸
       </div>
       <h3 class="text-lg font-bold text-purple-800 mb-3">Surat Lantikan Arbiter</h3>
       <p class="text-gray-700 text-sm mb-4">Surat lantikan rasmi untuk arbiter kejohanan</p><a href="https://drive.google.com/file/d/3cdefghijklmnopqr/view" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium text-sm"> ğŸ“¥ Muat Turun </a>
      </div>
     </div><!-- Additional Information -->
     <div class="mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">â„¹ï¸ Maklumat Tambahan</h3>
      <div class="space-y-3 text-sm text-gray-700">
       <div class="flex items-start gap-3"><span class="text-orange-600 font-bold">â€¢</span> <span>Semua dokumen disediakan dalam format PDF dan boleh dimuat turun terus dari Google Drive</span>
       </div>
       <div class="flex items-start gap-3"><span class="text-orange-600 font-bold">â€¢</span> <span>Sila pastikan anda mempunyai akses internet untuk memuat turun dokumen</span>
       </div>
       <div class="flex items-start gap-3"><span class="text-orange-600 font-bold">â€¢</span> <span>Jika menghadapi masalah akses, sila hubungi pihak penganjur</span>
       </div>
       <div class="flex items-start gap-3"><span class="text-orange-600 font-bold">â€¢</span> <span>Dokumen akan dikemas kini dari semasa ke semasa mengikut keperluan</span>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div id="dashboard" class="tab-content">
    <div class="bg-white rounded-lg shadow-lg p-6">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-orange-600">Dashboard Pendaftaran</h2>
      <div class="flex gap-2"><button onclick="showGoogleSheetsChecklist()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium text-sm"> ğŸ”§ Setup Checklist </button> <button onclick="loadFromGoogleSheets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"> ğŸ”„ Segerak dengan Google Sheets </button>
      </div>
     </div><!-- Summary Cards -->
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalRegistrations">
        0
       </div>
       <div class="text-orange-100 mt-2">
        Jumlah Pendaftaran
       </div>
      </div>
      <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalStudents">
        0
       </div>
       <div class="text-amber-100 mt-2">
        Jumlah Pelajar
       </div>
      </div>
      <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalSchools">
        0
       </div>
       <div class="text-yellow-100 mt-2">
        Jumlah Sekolah
       </div>
      </div>
      <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalTeachers">
        0
       </div>
       <div class="text-red-100 mt-2">
        Jumlah Guru
       </div>
      </div>
     </div><!-- Tree Diagram -->
     <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 mb-8">
      <h3 class="text-xl font-bold text-indigo-800 mb-6 text-center">ğŸ“Š Analisis Pendaftaran Mengikut Kategori</h3>
      <div id="treeDiagram" class="space-y-6"><!-- Root Level -->
       <div class="text-center">
        <div class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold text-lg"><span id="treeTotal">0</span> Sekolah Berdaftar
        </div>
        <div class="text-xs text-gray-600 mt-2">
         *Sekolah Rendah (U12) &amp; Sekolah Menengah (U15/U18)
        </div>
       </div><!-- Level 1: School Types -->
       <div class="flex justify-center">
        <div class="w-px h-8 bg-gray-400"></div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-8"><!-- Primary Schools -->
        <div class="text-center">
         <div class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold mb-4">
          <div class="text-2xl font-bold" id="primarySchools">
           0
          </div>
          <div class="text-sm">
           Sekolah Rendah
          </div>
          <div class="text-xs opacity-90">
           (SK, SJKC, SJKT dengan U12)
          </div>
         </div><!-- Primary Categories -->
         <div class="space-y-3">
          <div class="bg-green-100 border border-green-300 rounded-lg p-3">
           <div class="font-semibold text-green-800 mb-2">
            Bawah 12 Tahun
           </div>
           <div class="grid grid-cols-2 gap-2 text-sm mb-3">
            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded"><span class="font-bold" id="primary12Male">0</span> Lelaki
            </div>
            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded"><span class="font-bold" id="primary12Female">0</span> Perempuan
            </div>
           </div><!-- Race breakdown for U12 -->
           <div class="bg-white rounded-lg p-2 text-xs">
            <div class="font-semibold text-gray-700 mb-2">
             Mengikut Bangsa:
            </div>
            <div class="grid grid-cols-2 gap-1">
             <div class="flex justify-between"><span>ğŸ”¹ Melayu:</span> <span class="font-bold text-gray-800" id="primary12Melayu">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Cina:</span> <span class="font-bold text-gray-800" id="primary12Cina">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ India:</span> <span class="font-bold text-gray-800" id="primary12India">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Bumip.:</span> <span class="font-bold text-gray-800" id="primary12Bumip">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Lain:</span> <span class="font-bold text-gray-800" id="primary12Lain">0</span>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div><!-- Secondary Schools -->
        <div class="text-center">
         <div class="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold mb-4">
          <div class="text-2xl font-bold" id="secondarySchools">
           0
          </div>
          <div class="text-sm">
           Sekolah Menengah
          </div>
          <div class="text-xs opacity-90">
           (SMK, SMKA dengan U15/U18)
          </div>
         </div><!-- Secondary Categories -->
         <div class="space-y-3">
          <div class="bg-purple-100 border border-purple-300 rounded-lg p-3">
           <div class="font-semibold text-purple-800 mb-2">
            Bawah 15 Tahun
           </div>
           <div class="grid grid-cols-2 gap-2 text-sm mb-3">
            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded"><span class="font-bold" id="secondary15Male">0</span> Lelaki
            </div>
            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded"><span class="font-bold" id="secondary15Female">0</span> Perempuan
            </div>
           </div><!-- Race breakdown for U15 -->
           <div class="bg-white rounded-lg p-2 text-xs">
            <div class="font-semibold text-gray-700 mb-2">
             Mengikut Bangsa:
            </div>
            <div class="grid grid-cols-2 gap-1">
             <div class="flex justify-between"><span>ğŸ”¹ Melayu:</span> <span class="font-bold text-gray-800" id="secondary15Melayu">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Cina:</span> <span class="font-bold text-gray-800" id="secondary15Cina">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ India:</span> <span class="font-bold text-gray-800" id="secondary15India">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Bumip.:</span> <span class="font-bold text-gray-800" id="secondary15Bumip">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Lain:</span> <span class="font-bold text-gray-800" id="secondary15Lain">0</span>
             </div>
            </div>
           </div>
          </div>
          <div class="bg-purple-100 border border-purple-300 rounded-lg p-3">
           <div class="font-semibold text-purple-800 mb-2">
            Bawah 18 Tahun
           </div>
           <div class="grid grid-cols-2 gap-2 text-sm mb-3">
            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded"><span class="font-bold" id="secondary18Male">0</span> Lelaki
            </div>
            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded"><span class="font-bold" id="secondary18Female">0</span> Perempuan
            </div>
           </div><!-- Race breakdown for U18 -->
           <div class="bg-white rounded-lg p-2 text-xs">
            <div class="font-semibold text-gray-700 mb-2">
             Mengikut Bangsa:
            </div>
            <div class="grid grid-cols-2 gap-1">
             <div class="flex justify-between"><span>ğŸ”¹ Melayu:</span> <span class="font-bold text-gray-800" id="secondary18Melayu">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Cina:</span> <span class="font-bold text-gray-800" id="secondary18Cina">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ India:</span> <span class="font-bold text-gray-800" id="secondary18India">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Bumip.:</span> <span class="font-bold text-gray-800" id="secondary18Bumip">0</span>
             </div>
             <div class="flex justify-between"><span>ğŸ”¹ Lain:</span> <span class="font-bold text-gray-800" id="secondary18Lain">0</span>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Detailed School List -->
     <div class="bg-white rounded-lg border border-gray-200 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ Senarai Sekolah Berdaftar</h3>
      <div id="registrationsList" class="space-y-4">
      </div>
     </div>
    </div>
   </div>
  </div><!-- Google Sheets Setup Modal -->
  <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-purple-600">ï¿½ï¿½ Google Sheets Setup Checklist</h2><button onclick="closeSetupModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
     </div>
     <div class="space-y-6"><!-- Current Configuration -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
       <h3 class="text-lg font-semibold text-blue-800 mb-3">ğŸ“‹ Current Configuration</h3>
       <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="font-medium">Google Apps Script URL:</span> <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" id="currentScriptUrl">Loading...</span>
        </div>
        <div class="flex justify-between"><span class="font-medium">Connection Status:</span> <span id="connectionStatus" class="px-2 py-1 rounded text-xs">Testing...</span>
        </div>
       </div>
      </div><!-- Step-by-Step Setup -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-4">
       <h3 class="text-lg font-semibold text-green-800 mb-4">âœ… Setup Steps</h3>
       <div class="space-y-4"><!-- Step 1 -->
        <div class="border-l-4 border-green-500 pl-4">
         <h4 class="font-semibold text-green-700">Step 1: Create Google Spreadsheet</h4>
         <p class="text-sm text-gray-700 mt-1">Create a new Google Spreadsheet with these exact sheet names:</p>
         <ul class="text-xs text-gray-600 mt-2 ml-4 list-disc">
          <li><code>GURU</code> - Teacher information</li>
          <li><code>SEKOLAH</code> - School registration data</li>
          <li><code>PELAJAR</code> - Student information</li>
         </ul>
         <div class="mt-2"><input type="text" id="spreadsheetId" placeholder="Paste your Spreadsheet ID here" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
          <p class="text-xs text-gray-500 mt-1">Get this from your spreadsheet URL: docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</p>
         </div>
        </div><!-- Step 2 -->
        <div class="border-l-4 border-yellow-500 pl-4">
         <h4 class="font-semibold text-yellow-700">Step 2: Create Google Apps Script</h4>
         <p class="text-sm text-gray-700 mt-1">Go to <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">script.google.com</a> and create a new project</p>
         <div class="bg-gray-100 p-3 rounded mt-2 text-xs font-mono overflow-x-auto">
          <div class="mb-2 font-bold">
           Copy this code to your Apps Script:
          </div>
          <pre id="appsScriptCode">// MSSD Catur Registration System - Google Apps Script
// Your spreadsheet ID is already configured below

const SPREADSHEET_ID = '${spreadsheetId}';

function doGet(e) {
  try {
    const action = e.parameter.action;
    const callback = e.parameter.callback;
    
    let result = {};
    
    if (action === 'load') {
      result = loadRegistrations();
    } else if (action === 'search') {
      const regId = e.parameter.regId;
      const password = e.parameter.password;
      result = searchRegistration(regId, password);
    }
    
    // JSONP response
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(result) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    const errorResult = { error: error.toString() };
    const callback = e.parameter.callback;
    
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(errorResult) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(errorResult))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    if (action === 'submit' || action === 'update') {
      return saveRegistration(data);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: 'Unknown action' }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function loadRegistrations() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Create sheets if they don't exist
    let teacherSheet = ss.getSheetByName('GURU');
    if (!teacherSheet) {
      teacherSheet = ss.insertSheet('GURU');
      teacherSheet.getRange(1, 1, 1, 10).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'NAMA GURU', 'EMAIL GURU', 'TELEFON GURU', 'JAWATAN GURU', 'URUTAN GURU', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    let schoolSheet = ss.getSheetByName('SEKOLAH');
    if (!schoolSheet) {
      schoolSheet = ss.insertSheet('SEKOLAH');
      schoolSheet.getRange(1, 1, 1, 14).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'JENIS SEKOLAH', 'JUMLAH GURU', 'JUMLAH PELAJAR', 'JUMLAH LELAKI', 'JUMLAH PEREMPUAN', 'JUMLAH U12', 'JUMLAH U15', 'JUMLAH U18', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS', 'CATATAN']]);
    }
    
    let studentSheet = ss.getSheetByName('PELAJAR');
    if (!studentSheet) {
      studentSheet = ss.insertSheet('PELAJAR');
      studentSheet.getRange(1, 1, 1, 14).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'NAMA PELAJAR', 'NO IC', 'JANTINA', 'KATEGORI UMUR', 'KATEGORI DISPLAY', 'BANGSA', 'ID PEMAIN', 'GURU KETUA', 'TELEFON GURU', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    const registrations = {};
    
    // Load data from sheets
    const schoolData = schoolSheet.getDataRange().getValues();
    const teacherData = teacherSheet.getDataRange().getValues();
    const studentData = studentSheet.getDataRange().getValues();
    
    // Process schools (skip header row)
    for (let i = 1; i &lt; schoolData.length; i++) {
      const row = schoolData[i];
      const regId = row[0];
      if (regId) {
        registrations[regId] = {
          schoolName: row[1],
          schoolType: row[2],
          createdAt: row[10],
          updatedAt: row[11],
          status: row[12],
          teachers: [],
          students: []
        };
      }
    }
    
    // Process teachers (skip header row)
    for (let i = 1; i &lt; teacherData.length; i++) {
      const row = teacherData[i];
      const regId = row[0];
      if (regId &amp;&amp; registrations[regId]) {
        registrations[regId].teachers.push({
          name: row[2],
          email: row[3],
          phone: row[4],
          position: row[5],
          order: row[6]
        });
      }
    }
    
    // Process students (skip header row)
    for (let i = 1; i &lt; studentData.length; i++) {
      const row = studentData[i];
      const regId = row[0];
      if (regId &amp;&amp; registrations[regId]) {
        registrations[regId].students.push({
          name: row[2],
          ic: row[3],
          gender: row[4],
          category: row[5],
          categoryDisplay: row[6],
          race: row[7],
          playerId: row[8]
        });
      }
    }
    
    return { registrations: registrations };
    
  } catch (error) {
    return { error: 'Failed to load data: ' + error.toString() };
  }
}

function saveRegistration(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const teacherSheet = ss.getSheetByName('GURU');
    const schoolSheet = ss.getSheetByName('SEKOLAH');
    const studentSheet = ss.getSheetByName('PELAJAR');
    
    const regId = data.registrationId;
    const isUpdate = data.action === 'update';
    
    // For updates, preserve original creation date
    let createdDate, updatedDate;
    if (isUpdate &amp;&amp; data.originalCreatedAt) {
      createdDate = new Date(data.originalCreatedAt);
      updatedDate = new Date(data.updateTimestamp);
    } else {
      // New registration - both dates are the same
      createdDate = updatedDate = new Date(data.timestamp || new Date());
    }
    
    // Determine school type - use provided schoolType or auto-detect
    let schoolType = data.schoolType || 'LAIN-LAIN';
    
    // Calculate statistics
    const totalTeachers = data.teachers.length;
    const totalStudents = data.students.length;
    let totalMale = 0, totalFemale = 0;
    let totalU12 = 0, totalU15 = 0, totalU18 = 0;
    
    data.students.forEach(student =&gt; {
      if (student.gender === 'Lelaki') totalMale++;
      else totalFemale++;
      
      if (student.category.includes('12')) totalU12++;
      else if (student.category.includes('15')) totalU15++;
      else if (student.category.includes('18')) totalU18++;
    });
    
    // Clear existing data for this registration
    [teacherSheet, schoolSheet, studentSheet].forEach(sheet =&gt; {
      const sheetData = sheet.getDataRange().getValues();
      for (let i = sheetData.length - 1; i &gt;= 1; i--) {
        if (sheetData[i][0] === regId) {
          sheet.deleteRow(i + 1);
        }
      }
    });
    
    // Save school data - preserve original creation date for updates
    schoolSheet.appendRow([
      regId, data.schoolName, schoolType, totalTeachers, totalStudents,
      totalMale, totalFemale, totalU12, totalU15, totalU18,
      createdDate, updatedDate, 'AKTIF', ''
    ]);
    
    // Save teachers - preserve original creation date for updates
    data.teachers.forEach((teacher, index) =&gt; {
      const position = index === 0 ? 'KETUA' : 'PENGIRING';
      const order = index + 1;
      
      teacherSheet.appendRow([
        regId, data.schoolName, teacher.name, teacher.email, teacher.phone,
        position, order, createdDate, updatedDate, 'AKTIF'
      ]);
    });
    
    // Save students - preserve original creation date for updates
    const headTeacher = data.teachers[0];
    data.students.forEach(student =&gt; {
      // Generate category display (L12, P15, etc.)
      const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
      const ageCode = student.category.includes('12') ? '12' : 
                     student.category.includes('15') ? '15' : '18';
      const categoryDisplay = genderCode + ageCode;
      
      studentSheet.appendRow([
        regId, data.schoolName, student.name, student.ic, student.gender,
        student.category, categoryDisplay, student.race, student.playerId,
        headTeacher.name, headTeacher.phone, createdDate, updatedDate, 'AKTIF'
      ]);
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: true, registrationId: regId }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function searchRegistration(regId, password) {
  try {
    const registrations = loadRegistrations();
    
    if (registrations.error) {
      return { found: false, error: registrations.error };
    }
    
    const registration = registrations.registrations[regId];
    if (!registration) {
      return { found: false, error: 'Registration not found' };
    }
    
    // Verify password (last 4 digits of first teacher's phone)
    if (registration.teachers.length &gt; 0) {
      const phone = registration.teachers[0].phone.replace(/\D/g, '');
      const last4 = phone.slice(-4);
      
      if (last4 === password) {
        return { found: true, registration: registration };
      }
    }
    
    return { found: false, error: 'Invalid password' };
    
  } catch (error) {
    return { found: false, error: error.toString() };
  }
}</pre>
         </div>
        </div><!-- Step 3 -->
        <div class="border-l-4 border-blue-500 pl-4">
         <h4 class="font-semibold text-blue-700">Step 3: Deploy as Web App</h4>
         <ol class="text-sm text-gray-700 mt-1 ml-4 list-decimal space-y-1">
          <li>Click "Deploy" ï¿½ï¿½ "New deployment"</li>
          <li>Choose type: "Web app"</li>
          <li>Execute as: "Me"</li>
          <li>Who has access: "Anyone"</li>
          <li>Click "Deploy" and copy the Web App URL</li>
         </ol>
         <div class="mt-2"><input type="text" id="webAppUrl" placeholder="Paste your Web App URL here" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
         </div>
        </div><!-- Step 4 -->
        <div class="border-l-4 border-purple-500 pl-4">
         <h4 class="font-semibold text-purple-700">Step 4: Test Connection</h4>
         <p class="text-sm text-gray-700 mt-1">Click the button below to test your setup:</p><button onclick="testGoogleSheetsConnection()" class="mt-2 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm"> ğŸ§ª Test Connection </button>
         <div id="testResult" class="mt-2 text-sm"></div>
        </div>
       </div>
      </div><!-- Troubleshooting -->
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
       <h3 class="text-lg font-semibold text-red-800 mb-3">ğŸš¨ Common Issues</h3>
       <div class="space-y-2 text-sm text-gray-700">
        <div>
         <strong>CORS Error:</strong> Make sure your Apps Script is deployed as "Anyone" can access
        </div>
        <div>
         <strong>404 Error:</strong> Check your Web App URL is correct and deployment is active
        </div>
        <div>
         <strong>Permission Error:</strong> Ensure the script has permission to access your spreadsheet
        </div>
        <div>
         <strong>Timeout:</strong> Your script might be taking too long - check for infinite loops
        </div>
       </div>
      </div><!-- Save Configuration -->
      <div class="flex justify-end gap-3"><button onclick="closeSetupModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"> Cancel </button> <button onclick="saveGoogleSheetsConfig()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"> ğŸ’¾ Save Configuration </button>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        let registrations = {};
        let teacherCount = 1;
        let studentCount = 1;
        let editTeacherCount = 0;
        let editStudentCount = 0;
        let currentEditData = null;
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWNUtbfV4VKvsmbGyD4RWNUEVFdKwkk8bOsXuPdBkfgJ_-QFySGx0uJmfsBW5087mlPQ/exec';
        let isLoadingFromSheets = false;

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-orange-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-orange-600', 'text-white');
            
            if (tabName === 'dashboard') {
                updateDashboard();
                // Auto-sync with Google Sheets when dashboard is opened
                loadFromGoogleSheets();
            }
        }

        function switchRegistrationTab(tabName) {
            // Hide all registration tab contents
            document.querySelectorAll('.registration-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Reset all registration tab buttons
            document.querySelectorAll('.registration-tab-btn').forEach(btn => {
                btn.classList.remove('border-orange-600', 'text-orange-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.remove('hidden');
            
            // Activate selected tab button
            const activeBtn = document.querySelector(`[data-reg-tab="${tabName}"]`);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-orange-600', 'text-orange-600');
            
            // Clear search form when switching to kemaskini tab
            if (tabName === 'kemaskini') {
                clearSearch();
            }
        }



        function formatSchoolName(name) {
            name = name.toUpperCase();
            name = name.replace(/SEKOLAH KEBANGSAAN/gi, 'SK');
            name = name.replace(/SEKOLAH MENENGAH KEBANGSAAN AGAMA/gi, 'SMKA');
            name = name.replace(/SEKOLAH MENENGAH KEBANGSAAN/gi, 'SMK');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN \(CINA\)/gi, 'SJKC');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN \(TAMIL\)/gi, 'SJKT');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN/gi, 'SJK');
            return name;
        }

        function formatPhoneNumber(phone) {
            phone = phone.replace(/\D/g, '');
            if (phone.length >= 11) {
                return phone.substring(0, 3) + '-' + phone.substring(3, 6) + ' ' + phone.substring(6, 11);
            } else if (phone.length >= 10) {
                return phone.substring(0, 3) + '-' + phone.substring(3, 6) + ' ' + phone.substring(6, 10);
            }
            return phone;
        }

        function formatIC(ic) {
            ic = ic.replace(/\D/g, '');
            if (ic.length >= 12) {
                return ic.substring(0, 6) + '-' + ic.substring(6, 8) + '-' + ic.substring(8, 12);
            }
            return ic;
        }

        document.getElementById('schoolName').addEventListener('input', function(e) {
            e.target.value = formatSchoolName(e.target.value);
        });

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('teacher-name') || e.target.classList.contains('student-name')) {
                e.target.value = e.target.value.toUpperCase();
            }
            
            if (e.target.classList.contains('teacher-phone')) {
                e.target.value = formatPhoneNumber(e.target.value);
            }
            
            if (e.target.classList.contains('student-ic')) {
                e.target.value = formatIC(e.target.value);
            }
            
            if (e.target.classList.contains('student-gender') || e.target.classList.contains('student-category')) {
                updateStudentIds();
            }
            
            // Filter categories based on school type
            if (e.target.id === 'schoolType') {
                updateCategoryOptions();
            }
        });

        function updateCategoryOptions() {
            const schoolType = document.getElementById('schoolType').value;
            const categorySelects = document.querySelectorAll('.student-category');
            
            categorySelects.forEach(select => {
                // Store current value
                const currentValue = select.value;
                
                // Clear options
                select.innerHTML = '<option value="">Pilih Kategori</option>';
                
                // Add appropriate options based on school type
                if (schoolType === 'Sekolah Kebangsaan') {
                    select.innerHTML += '<option value="Bawah 12 Tahun">Bawah 12 Tahun</option>';
                } else if (schoolType === 'Sekolah Menengah') {
                    select.innerHTML += '<option value="Bawah 15 Tahun">Bawah 15 Tahun</option>';
                    select.innerHTML += '<option value="Bawah 18 Tahun">Bawah 18 Tahun</option>';
                } else {
                    select.innerHTML += '<option value="Bawah 12 Tahun">Bawah 12 Tahun</option>';
                    select.innerHTML += '<option value="Bawah 15 Tahun">Bawah 15 Tahun</option>';
                    select.innerHTML += '<option value="Bawah 18 Tahun">Bawah 18 Tahun</option>';
                }
                
                // Restore value if still valid
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function generatePlayerId(gender, schoolName, studentIndex, category, regId) {
            const year = new Date().getFullYear().toString().slice(-2);
            
            // Category code based on age group
            let categoryCode = '15'; // default
            if (category.includes('12')) {
                categoryCode = '12';
            } else if (category.includes('15')) {
                categoryCode = '15';
            } else if (category.includes('18')) {
                categoryCode = '18';
            }
            
            // Gender code
            const genderCode = gender === 'Lelaki' ? '01' : '02';
            
            // School number from registration ID (last 2 digits)
            const schoolNo = regId ? regId.split('-').pop().padStart(2, '0') : '00';
            
            // Player number for this registration (2 digits)
            const playerCount = String(studentIndex + 1).padStart(2, '0');
            
            return `${year}${categoryCode}${genderCode}${schoolNo}${playerCount}`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        function updateStudentIds() {
            const schoolName = document.getElementById('schoolName').value;
            const students = document.querySelectorAll('.student-entry');
            
            // Get the first student's category to generate registration ID
            const firstStudent = students[0];
            if (firstStudent) {
                const firstCategory = firstStudent.querySelector('.student-category').value;
                if (firstCategory) {
                    const tempRegId = generateRegistrationId(firstCategory);
                    
                    students.forEach((student, index) => {
                        const gender = student.querySelector('.student-gender').value;
                        const category = student.querySelector('.student-category').value;
                        const idField = student.querySelector('.student-id');
                        
                        if (gender && schoolName && category) {
                            idField.value = generatePlayerId(gender, schoolName, index, category, tempRegId);
                        }
                    });
                }
            }
        }

        function addTeacher() {
            const container = document.getElementById('teachersContainer');
            const newTeacher = document.createElement('div');
            newTeacher.className = 'teacher-entry bg-orange-50 p-4 rounded-lg mb-4';
            newTeacher.setAttribute('data-teacher-index', teacherCount);
            
            newTeacher.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Guru ${teacherCount + 1} (Pengiring)</h4>
                    <button type="button" onclick="removeTeacher(${teacherCount})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                        ğŸ—‘ï¿½ï¿½ï¿½ Buang
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                        <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                        <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                        <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                    </div>
                </div>
            `;
            
            container.appendChild(newTeacher);
            teacherCount++;
        }

        function removeTeacher(index) {
            const teachers = document.querySelectorAll('.teacher-entry');
            if (teachers.length > 1 && index > 0) {
                const teacher = document.querySelector(`[data-teacher-index="${index}"]`);
                teacher.remove();
            } else if (index === 0) {
                showNotification('Guru 1 (Ketua) tidak boleh dibuang!', 'error');
            } else {
                showNotification('Minimum 1 guru diperlukan!', 'error');
            }
        }

        function addStudent() {
            const container = document.getElementById('studentsContainer');
            const newStudent = document.createElement('div');
            newStudent.className = 'student-entry bg-orange-50 p-4 rounded-lg mb-4';
            newStudent.setAttribute('data-student-index', studentCount);
            
            newStudent.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Pelajar ${studentCount + 1}</h4>
                    <button type="button" onclick="removeStudent(${studentCount})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                        ğŸ—‘ï¸ Buang
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                        <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                        <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                        <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Jantina</option>
                            <option value="Lelaki">Lelaki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                        <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Kategori</option>
                            <option value="Bawah 12 Tahun">Bawah 12 Tahun</option>
                            <option value="Bawah 15 Tahun">Bawah 15 Tahun</option>
                            <option value="Bawah 18 Tahun">Bawah 18 Tahun</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                        <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
                    </div>
                </div>
            `;
            
            container.appendChild(newStudent);
            studentCount++;
            updateStudentIds();
        }

        function removeStudent(index) {
            const student = document.querySelector(`[data-student-index="${index}"]`);
            if (student) {
                student.remove();
                updateStudentIds();
            }
        }

        function generateRegistrationId(category) {
            // Count existing registrations by category
            let categoryCount = 0;
            Object.values(registrations).forEach(reg => {
                const hasCategory = reg.students.some(student => student.category === category);
                if (hasCategory) {
                    categoryCount++;
                }
            });
            
            // Category code: 01 for Bawah 12, 02 for Bawah 15 & 18
            const categoryCode = category.includes('12') ? '01' : '02';
            
            // Sequential count for this category
            const count = String(categoryCount + 1).padStart(2, '0');
            
            return `MSSD-${categoryCode}-${count}`;
        }

        function collectFormData() {
            const schoolName = document.getElementById('schoolName').value;
            const schoolType = document.getElementById('schoolType').value;
            
            const teachers = [];
            document.querySelectorAll('.teacher-entry').forEach((entry, index) => {
                teachers.push({
                    name: entry.querySelector('.teacher-name').value,
                    email: entry.querySelector('.teacher-email').value,
                    phone: entry.querySelector('.teacher-phone').value,
                    position: index === 0 ? 'Ketua' : 'Pengiring'
                });
            });
            
            const students = [];
            document.querySelectorAll('.student-entry').forEach((entry, index) => {
                const gender = entry.querySelector('.student-gender').value;
                const category = entry.querySelector('.student-category').value;
                
                // Generate player ID with proper registration ID
                let playerId = entry.querySelector('.student-id').value;
                if (gender && category && schoolName) {
                    const tempRegId = generateRegistrationId(category);
                    playerId = generatePlayerId(gender, schoolName, index, category, tempRegId);
                }
                
                students.push({
                    name: entry.querySelector('.student-name').value,
                    ic: entry.querySelector('.student-ic').value,
                    gender: gender,
                    race: entry.querySelector('.student-race').value,
                    category: category,
                    playerId: playerId
                });
            });
            
            return { schoolName, schoolType, teachers, students };
        }

        async function sendToGoogleSheets(regId, data) {
            if (!GOOGLE_SCRIPT_URL) {
                return;
            }
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'submit',
                        registrationId: regId,
                        schoolName: data.schoolName,
                        schoolType: data.schoolType,
                        teachers: data.teachers,
                        students: data.students,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
            }
        }

        async function loadFromGoogleSheets() {
            if (!GOOGLE_SCRIPT_URL || isLoadingFromSheets) {
                console.log('Sync skipped - already loading or no URL');
                return;
            }
            
            console.log('ğŸ”„ Starting Google Sheets sync...');
            isLoadingFromSheets = true;
            showSyncStatus('ğŸ”„ Menyegerak dengan Google Sheets...', 'info');
            
            try {
                // Use JSONP approach for no-cors requests
                const callbackName = 'googleSheetsCallback_' + Date.now();
                console.log('ğŸ“¡ Creating JSONP request with callback:', callbackName);
                
                // Create a promise that resolves when callback is called
                const dataPromise = new Promise((resolve, reject) => {
                    // Set up callback function
                    window[callbackName] = function(data) {
                        console.log('ğŸ“¥ Received data from Google Sheets:', data);
                        resolve(data);
                        // Clean up
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                    };
                    
                    // Create script element for JSONP
                    const script = document.createElement('script');
                    const requestUrl = `${GOOGLE_SCRIPT_URL}?action=load&callback=${callbackName}`;
                    console.log('ğŸŒ Request URL:', requestUrl);
                    script.src = requestUrl;
                    
                    script.onerror = (error) => {
                        console.error('âŒ Script loading failed:', error);
                        reject(new Error('Failed to load script'));
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                    };
                    
                    script.onload = () => {
                        console.log('âœ… Script loaded successfully');
                    };
                    
                    document.head.appendChild(script);
                    
                    // Timeout after 15 seconds (increased from 10)
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.log('â° Request timeout after 15 seconds');
                            reject(new Error('Request timeout'));
                            delete window[callbackName];
                            if (script.parentNode) {
                                document.head.removeChild(script);
                            }
                        }
                    }, 15000);
                });
                
                const data = await dataPromise;
                console.log('ğŸ“Š Processing received data...');
                
                if (data && typeof data === 'object') {
                    if (data.error) {
                        console.error('âŒ Server returned error:', data.error);
                        showSyncStatus('âŒ Ralat dari server: ' + data.error, 'error');
                        return;
                    }
                    
                    if (data.registrations && typeof data.registrations === 'object') {
                        console.log('âœ… Valid registrations data received:', Object.keys(data.registrations).length, 'entries');
                        
                        // Merge Google Sheets data with local data (preserve local changes)
                        const sheetsData = data.registrations;
                        const mergedData = { ...registrations }; // Start with local data
                        
                        // Add/update with Google Sheets data, but preserve newer local changes
                        Object.keys(sheetsData).forEach(regId => {
                            const sheetsReg = sheetsData[regId];
                            const localReg = mergedData[regId];
                            
                            if (!localReg) {
                                // New registration from sheets
                                mergedData[regId] = sheetsReg;
                            } else {
                                // Compare timestamps if available
                                const sheetsTime = new Date(sheetsReg.updatedAt || sheetsReg.createdAt || 0);
                                const localTime = new Date(localReg.updatedAt || localReg.createdAt || 0);
                                
                                if (sheetsTime > localTime) {
                                    // Sheets data is newer
                                    mergedData[regId] = sheetsReg;
                                }
                                // Otherwise keep local data (it's newer)
                            }
                        });
                        
                        registrations = mergedData;
                        
                        // Save merged data to local storage
                        localStorage.setItem('registrations', JSON.stringify(registrations));
                        
                        // Force update dashboard
                        updateDashboard();
                        
                        const sheetsCount = Object.keys(data.registrations).length;
                        const totalCount = Object.keys(registrations).length;
                        showSyncStatus(`âœ… Segerak berjaya! ${sheetsCount} dari server, ${totalCount} jumlah`, 'success');
                    } else {
                        console.log('â„¹ï¸ No registrations data in response');
                        showSyncStatus('â„¹ï¸ Tiada data pendaftaran dari server', 'info');
                    }
                } else {
                    console.log('âš ï¸ Invalid or empty response from server');
                    showSyncStatus('ï¿½ï¿½ï¿½ï¸ Respons tidak sah dari server', 'warning');
                }
            } catch (error) {
                console.error('âŒ Sync error:', error);
                showSyncStatus('âŒ Gagal segerak: ' + error.message, 'error');
            } finally {
                isLoadingFromSheets = false;
                console.log('ğŸ Sync process completed');
            }
        }



        function sendWhatsAppNotification(regId, data, isNew) {
            if (!isNew) return;
            
            const categoryCounts = {
                'L12': 0, 'P12': 0,
                'L15': 0, 'P15': 0,
                'L18': 0, 'P18': 0
            };
            
            data.students.forEach(student => {
                const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                const ageCode = student.category.includes('12') ? '12' : 
                               student.category.includes('15') ? '15' : '18';
                categoryCounts[genderCode + ageCode]++;
            });
            
            // Generate category breakdown text
            const categoryBreakdown = [];
            if (categoryCounts.L12 > 0) categoryBreakdown.push(`L12 - ${categoryCounts.L12} orang`);
            if (categoryCounts.P12 > 0) categoryBreakdown.push(`P12 - ${categoryCounts.P12} orang`);
            if (categoryCounts.L15 > 0) categoryBreakdown.push(`L15 - ${categoryCounts.L15} orang`);
            if (categoryCounts.P15 > 0) categoryBreakdown.push(`P15 - ${categoryCounts.P15} orang`);
            if (categoryCounts.L18 > 0) categoryBreakdown.push(`L18 - ${categoryCounts.L18} orang`);
            if (categoryCounts.P18 > 0) categoryBreakdown.push(`P18 - ${categoryCounts.P18} orang`);
            
            const categoryText = categoryBreakdown.join(', ');
            
            // Create the complete WhatsApp message with proper encoding
            const messageLines = [
                'ğŸ“¢ NOTIFIKASI PENDAFTARAN BERJAYA',
                '',
                'Assalamualaikum & Salam Sejahtera ğŸ‘‹',
                '',
                'Saya telah berjaya mendaftar pasukan sekolah untuk PERTANDINGAN CATUR MSSD MUAR âœ…',
                '',
                `ğŸ« Nama Sekolah: ${data.schoolName}`,
                `ğŸ†” ID Pendaftaran: ${regId}`,
                `ğŸ‘©â€ğŸ« Nama Guru (Ketua): ${data.teachers[0].name}`,
                `ğŸ“ No. Telefon Guru: ${data.teachers[0].phone}`,
                `ï¿½ï¿½ Jumlah Pelajar: ${data.students.length} orang (${categoryText})`,
                '',
                'Terima kasih atas sokongan dan penyertaan anda. ğŸ™',
                'Sebarang maklumat lanjut akan dimaklumkan melalui WhatsApp rasmi MSSD Catur. ğŸ“±',
                '',
                'â™Ÿï¸ "Satukan Pemain, Gilap Bakat, Ukir Kejayaan" ğŸ†'
            ];
            
            // Join with line breaks and encode for URL
            const message = encodeURIComponent(messageLines.join('\n'));
            
            const whatsappUrl = `https://wa.me/60182046224?text=${message}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }

        function handleSubmit(event) {
            event.preventDefault();
            
            const data = collectFormData();
            
            // Generate new registration ID
            let regId;
            if (data.students.length > 0) {
                regId = generateRegistrationId(data.students[0].category);
            }
            
            // Ensure we have a valid registration ID
            if (!regId) {
                showNotification('âŒ Ralat: Tidak dapat menentukan ID pendaftaran', 'error');
                return;
            }
            
            // Save to local storage immediately for offline access
            const registrationData = {
                schoolName: data.schoolName,
                teachers: data.teachers,
                students: data.students,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                status: 'AKTIF'
            };
            
            registrations[regId] = registrationData;
            localStorage.setItem('registrations', JSON.stringify(registrations));
            
            // Send to Google Sheets (async, won't block UI)
            sendToGoogleSheets(regId, data);
            
            showNotification(
                `âœ… Pendaftaran berjaya! ID Pendaftaran: ${regId}. Sila simpan ID ini untuk rujukan.`,
                'success'
            );
            
            // Send WhatsApp notification
            sendWhatsAppNotification(regId, data, true);
            
            resetForm();
            
            // Update dashboard immediately with local data
            updateDashboard();
            
            // Refresh data from Google Sheets in background
            setTimeout(() => {
                loadFromGoogleSheets();
            }, 2000);
        }











        function resetForm() {
            // Reset submit button to default state
            const submitButton = document.getElementById('submitButton');
            submitButton.innerHTML = 'ğŸ’¾ Hantar Pendaftaran';
            submitButton.className = 'px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium';
            
            document.getElementById('registrationForm').reset();
            
            const teachersContainer = document.getElementById('teachersContainer');
            const studentsContainer = document.getElementById('studentsContainer');
            
            teachersContainer.innerHTML = `
                <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="0">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Guru 1 (Ketua) *</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                            <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                            <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                            <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                        </div>
                    </div>
                </div>
            `;
            
            studentsContainer.innerHTML = `
                <div class="student-entry bg-orange-50 p-4 rounded-lg mb-4" data-student-index="0">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Pelajar 1</h4>
                        <button type="button" onclick="removeStudent(0)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                            ğŸ—‘ï¸ Buang
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                            <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                            <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Bangsa *</label>
                            <select required class="student-race w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Pilih Bangsa</option>
                                <option value="Melayu">Melayu</option>
                                <option value="Cina">Cina</option>
                                <option value="India">India</option>
                                <option value="Bumiputera">Bumiputera</option>
                                <option value="Lain-lain">Lain-lain</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                            <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Pilih Jantina</option>
                                <option value="Lelaki">Lelaki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                            <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Pilih Kategori</option>
                                <option value="Bawah 12 Tahun">Bawah 12 Tahun</option>
                                <option value="Bawah 15 Tahun">Bawah 15 Tahun</option>
                                <option value="Bawah 18 Tahun">Bawah 18 Tahun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                            <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
                        </div>
                    </div>
                </div>
            `;
            
            teacherCount = 1;
            studentCount = 1;
        }

        function updateDashboard() {
            const totalRegs = Object.keys(registrations).length;
            let totalStudents = 0;
            let totalTeachers = 0;
            
            // Track schools by their valid categories
            const primarySchools = new Set(); // Schools with U12 students
            const secondarySchools = new Set(); // Schools with U15/U18 students
            const allSchools = new Set(); // All registered schools
            
            // Tree diagram counters
            let primarySchoolCount = 0;
            let secondarySchoolCount = 0;
            let primary12Male = 0, primary12Female = 0;
            let secondary15Male = 0, secondary15Female = 0;
            let secondary18Male = 0, secondary18Female = 0;
            
            // Race breakdown counters
            const raceBreakdown = {
                primary12: { Melayu: 0, Cina: 0, India: 0, Bumiputera: 0, 'Lain-lain': 0 },
                secondary15: { Melayu: 0, Cina: 0, India: 0, Bumiputera: 0, 'Lain-lain': 0 },
                secondary18: { Melayu: 0, Cina: 0, India: 0, Bumiputera: 0, 'Lain-lain': 0 }
            };
            
            Object.values(registrations).forEach(reg => {
                totalStudents += reg.students.length;
                totalTeachers += reg.teachers.length;
                allSchools.add(reg.schoolName);
                
                // Determine school type based on name
                const schoolName = reg.schoolName.toUpperCase();
                const isPrimarySchool = schoolName.includes('SK') || schoolName.includes('SJKC') || schoolName.includes('SJKT');
                const isSecondarySchool = schoolName.includes('SMK') || schoolName.includes('SMKA');
                
                // Check what categories this school has registered
                let hasU12 = false;
                let hasU15 = false;
                let hasU18 = false;
                
                // Count students by category and gender
                reg.students.forEach(student => {
                    const isMale = student.gender === 'Lelaki';
                    const race = student.race || 'Lain-lain';
                    
                    if (student.category.includes('12')) {
                        hasU12 = true;
                        if (isMale) primary12Male++;
                        else primary12Female++;
                        
                        // Count by race for U12
                        if (race === 'Melayu') raceBreakdown.primary12.Melayu++;
                        else if (race === 'Cina') raceBreakdown.primary12.Cina++;
                        else if (race === 'India') raceBreakdown.primary12.India++;
                        else if (race === 'Bumiputera') raceBreakdown.primary12.Bumiputera++;
                        else raceBreakdown.primary12['Lain-lain']++;
                        
                    } else if (student.category.includes('15')) {
                        hasU15 = true;
                        if (isMale) secondary15Male++;
                        else secondary15Female++;
                        
                        // Count by race for U15
                        if (race === 'Melayu') raceBreakdown.secondary15.Melayu++;
                        else if (race === 'Cina') raceBreakdown.secondary15.Cina++;
                        else if (race === 'India') raceBreakdown.secondary15.India++;
                        else if (race === 'Bumiputera') raceBreakdown.secondary15.Bumiputera++;
                        else raceBreakdown.secondary15['Lain-lain']++;
                        
                    } else if (student.category.includes('18')) {
                        hasU18 = true;
                        if (isMale) secondary18Male++;
                        else secondary18Female++;
                        
                        // Count by race for U18
                        if (race === 'Melayu') raceBreakdown.secondary18.Melayu++;
                        else if (race === 'Cina') raceBreakdown.secondary18.Cina++;
                        else if (race === 'India') raceBreakdown.secondary18.India++;
                        else if (race === 'Bumiputera') raceBreakdown.secondary18.Bumiputera++;
                        else raceBreakdown.secondary18['Lain-lain']++;
                    }
                });
                
                // Count schools based on categories they register for
                // Primary schools (RENDAH) - any school that registers U12 students
                if (hasU12) {
                    primarySchools.add(reg.schoolName);
                }
                
                // Secondary schools (MENENGAH) - any school that registers U15 or U18 students
                if (hasU15 || hasU18) {
                    secondarySchools.add(reg.schoolName);
                }
            });
            
            primarySchoolCount = primarySchools.size;
            secondarySchoolCount = secondarySchools.size;
            
            // Calculate total schools (primary with U12 + secondary with U15/U18)
            const totalSchools = primarySchoolCount + secondarySchoolCount;
            
            // Update summary cards
            document.getElementById('totalRegistrations').textContent = totalRegs;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalSchools').textContent = totalSchools;
            document.getElementById('totalTeachers').textContent = totalTeachers;
            
            // Update tree diagram
            document.getElementById('treeTotal').textContent = totalSchools;
            document.getElementById('primarySchools').textContent = primarySchoolCount;
            document.getElementById('secondarySchools').textContent = secondarySchoolCount;
            document.getElementById('primary12Male').textContent = primary12Male;
            document.getElementById('primary12Female').textContent = primary12Female;
            document.getElementById('secondary15Male').textContent = secondary15Male;
            document.getElementById('secondary15Female').textContent = secondary15Female;
            document.getElementById('secondary18Male').textContent = secondary18Male;
            document.getElementById('secondary18Female').textContent = secondary18Female;
            
            // Update race breakdown for U12
            document.getElementById('primary12Melayu').textContent = raceBreakdown.primary12.Melayu;
            document.getElementById('primary12Cina').textContent = raceBreakdown.primary12.Cina;
            document.getElementById('primary12India').textContent = raceBreakdown.primary12.India;
            document.getElementById('primary12Bumip').textContent = raceBreakdown.primary12.Bumiputera;
            document.getElementById('primary12Lain').textContent = raceBreakdown.primary12['Lain-lain'];
            
            // Update race breakdown for U15
            document.getElementById('secondary15Melayu').textContent = raceBreakdown.secondary15.Melayu;
            document.getElementById('secondary15Cina').textContent = raceBreakdown.secondary15.Cina;
            document.getElementById('secondary15India').textContent = raceBreakdown.secondary15.India;
            document.getElementById('secondary15Bumip').textContent = raceBreakdown.secondary15.Bumiputera;
            document.getElementById('secondary15Lain').textContent = raceBreakdown.secondary15['Lain-lain'];
            
            // Update race breakdown for U18
            document.getElementById('secondary18Melayu').textContent = raceBreakdown.secondary18.Melayu;
            document.getElementById('secondary18Cina').textContent = raceBreakdown.secondary18.Cina;
            document.getElementById('secondary18India').textContent = raceBreakdown.secondary18.India;
            document.getElementById('secondary18Bumip').textContent = raceBreakdown.secondary18.Bumiputera;
            document.getElementById('secondary18Lain').textContent = raceBreakdown.secondary18['Lain-lain'];
            
            const listContainer = document.getElementById('registrationsList');
            listContainer.innerHTML = '';
            
            if (totalRegs === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Tiada pendaftaran lagi.</div>';
                return;
            }
            
            Object.entries(registrations).forEach(([regId, data]) => {
                // Generate category summary
                const categorySummary = {
                    'L12': 0, 'P12': 0,
                    'L15': 0, 'P15': 0,
                    'L18': 0, 'P18': 0
                };
                
                data.students.forEach(student => {
                    const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                    const ageCode = student.category.includes('12') ? '12' : 
                                   student.category.includes('15') ? '15' : '18';
                    categorySummary[genderCode + ageCode]++;
                });
                
                const summaryText = Object.entries(categorySummary)
                    .filter(([key, count]) => count > 0)
                    .map(([key, count]) => `${key}: ${count}`)
                    .join(' | ');
                
                // Generate teachers list
                const teachersList = data.teachers.map((teacher, index) => 
                    `<div class="text-sm ${index === 0 ? 'font-semibold' : ''}">
                        ${teacher.name} ${index === 0 ? '(Ketua)' : '(Pengiring)'} - ${teacher.phone}
                    </div>`
                ).join('');

                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-lg border border-gray-200';
                card.innerHTML = `
                    <button onclick="toggleSchoolDetails('${regId}')" class="w-full text-left p-4 hover:bg-gray-100 transition-colors rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-indigo-900">${data.schoolName}</h3>
                                <p class="text-gray-600 text-sm mt-1">ID: ${regId} | Pelajar: ${data.students.length}</p>
                                <p class="text-gray-500 text-xs mt-1">Didaftar: ${new Date(data.createdAt).toLocaleString('ms-MY', { timeZone: 'Asia/Kuala_Lumpur' })}</p>
                            </div>
                            <div class="text-gray-400">
                                <span id="arrow-${regId}">â–¼</span>
                            </div>
                        </div>
                    </button>
                    
                    <div id="details-${regId}" class="hidden p-4 pt-0">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">ï¿½ï¿½â€ğŸ« Senarai Guru</h4>
                                <div class="space-y-2 mb-4">
                                    ${teachersList}
                                </div>
                                <div class="bg-orange-50 rounded-lg p-3 mt-3">
                                    <h5 class="font-semibold text-orange-700 text-sm mb-2">Ringkasan Pendaftaran</h5>
                                    <p class="text-xs text-gray-700">Jumlah Pelajar: <span class="font-bold">${data.students.length}</span></p>
                                    <p class="text-xs text-gray-700 mt-1">${summaryText}</p>
                                </div>
                            </div>
                            
                                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">ğŸ‘¥ Senarai Pelajar</h4>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${data.students.map(student => {
                                        const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                                        const ageCode = student.category.includes('12') ? '12' : 
                                                       student.category.includes('15') ? '15' : '18';
                                        return `<div class="text-xs flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="font-medium">${student.name}</span>
                                            <div class="flex gap-1">
                                                <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 font-bold">${genderCode}${ageCode}</span>
                                                <span class="px-2 py-1 rounded text-xs bg-purple-100 text-purple-800">${student.race || 'N/A'}</span>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(card);
            });
        }

        function toggleSchoolDetails(regId) {
            const detailsDiv = document.getElementById(`details-${regId}`);
            const arrow = document.getElementById(`arrow-${regId}`);
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                arrow.textContent = 'â–²';
            } else {
                detailsDiv.classList.add('hidden');
                arrow.textContent = 'â–¼';
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white max-w-md`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function showSyncStatus(message, type) {
            // Remove existing sync status
            const existingStatus = document.getElementById('syncStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const syncStatus = document.createElement('div');
            syncStatus.id = 'syncStatus';
            syncStatus.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-lg z-50 text-sm max-w-xs ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'warning' ? 'bg-yellow-500 text-black' : 
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'info' ? 'bg-blue-500 text-white' : 'bg-gray-500 text-white'
            }`;
            syncStatus.textContent = message;
            
            document.body.appendChild(syncStatus);
            
            // Keep loading messages longer, others shorter
            const timeout = type === 'info' ? 5000 : 3000;
            setTimeout(() => {
                if (syncStatus && syncStatus.parentNode) {
                    syncStatus.remove();
                }
            }, timeout);
        }

        // Load data on page load
        function loadLocalData() {
            const savedRegistrations = localStorage.getItem('registrations');
            if (savedRegistrations) {
                try {
                    registrations = JSON.parse(savedRegistrations);
                    console.log('âœ… Data tempatan dimuat:', Object.keys(registrations).length, 'pendaftaran');
                    updateDashboard();
                } catch (error) {
                    console.error('âŒ Ralat memuat data tempatan:', error);
                    registrations = {};
                }
            }
        }
        
        // Load local data first, then sync with Google Sheets
        loadLocalData();
        loadFromGoogleSheets();
        
        // Auto-sync every 30 seconds when dashboard is active
        setInterval(() => {
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab && currentTab.id === 'dashboard') {
                loadFromGoogleSheets();
            }
        }, 30000);

        // Google Sheets Setup Functions
        function showGoogleSheetsChecklist() {
            // Password protection for setup access
            const password = prompt('Masukkan kata laluan untuk akses setup:');
            if (password !== 'kamuscatur') {
                alert('âŒ Kata laluan salah! Akses ditolak.');
                return;
            }
            
            document.getElementById('setupModal').classList.remove('hidden');
            
            // Load saved configuration
            const savedSpreadsheetId = localStorage.getItem('spreadsheetId');
            const savedWebAppUrl = localStorage.getItem('webAppUrl');
            
            if (savedSpreadsheetId) {
                document.getElementById('spreadsheetId').value = savedSpreadsheetId;
            }
            if (savedWebAppUrl) {
                document.getElementById('webAppUrl').value = savedWebAppUrl;
                // Show current configuration from Web App URL input
                document.getElementById('currentScriptUrl').textContent = savedWebAppUrl || 'Not configured';
            } else {
                document.getElementById('currentScriptUrl').textContent = GOOGLE_SCRIPT_URL || 'Not configured';
            }
            
            // Generate Apps Script code template
            generateAppsScriptTemplate();
            
            // Test current connection
            testCurrentConnection();
        }

        function closeSetupModal() {
            document.getElementById('setupModal').classList.add('hidden');
        }

        function generateAppsScriptTemplate() {
            const spreadsheetId = document.getElementById('spreadsheetId').value || '1FJnBiWM5cuH0a1Yw0CxAR9zy_LiD1lVtQg9ijXRrPS4';
            
            const scriptTemplate = `// MSSD Catur Registration System - Google Apps Script
// Your spreadsheet ID is already configured below

const SPREADSHEET_ID = '${spreadsheetId}';

function doGet(e) {
  try {
    const action = e.parameter.action;
    const callback = e.parameter.callback;
    
    let result = {};
    
    if (action === 'load') {
      result = loadRegistrations();
    } else if (action === 'search') {
      const regId = e.parameter.regId;
      const password = e.parameter.password;
      result = searchRegistration(regId, password);
    }
    
    // JSONP response
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(result) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    const errorResult = { error: error.toString() };
    const callback = e.parameter.callback;
    
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(errorResult) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(errorResult))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    if (action === 'submit' || action === 'update') {
      return saveRegistration(data);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: 'Unknown action' }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function loadRegistrations() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Create sheets if they don't exist
    let teacherSheet = ss.getSheetByName('GURU');
    if (!teacherSheet) {
      teacherSheet = ss.insertSheet('GURU');
      teacherSheet.getRange(1, 1, 1, 10).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'NAMA GURU', 'EMAIL GURU', 'TELEFON GURU', 'JAWATAN GURU', 'URUTAN GURU', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    let schoolSheet = ss.getSheetByName('SEKOLAH');
    if (!schoolSheet) {
      schoolSheet = ss.insertSheet('SEKOLAH');
      schoolSheet.getRange(1, 1, 1, 13).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'JENIS SEKOLAH', 'JUMLAH GURU', 'JUMLAH PELAJAR', 'JUMLAH LELAKI', 'JUMLAH PEREMPUAN', 'JUMLAH U12', 'JUMLAH U15', 'JUMLAH U18', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    let studentSheet = ss.getSheetByName('PELAJAR');
    if (!studentSheet) {
      studentSheet = ss.insertSheet('PELAJAR');
      studentSheet.getRange(1, 1, 1, 14).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'NAMA PELAJAR', 'NO IC', 'JANTINA', 'KATEGORI UMUR', 'KATEGORI DISPLAY', 'BANGSA', 'ID PEMAIN', 'GURU KETUA', 'TELEFON GURU', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    const registrations = {};
    
    // Load data from sheets
    const schoolData = schoolSheet.getDataRange().getValues();
    const teacherData = teacherSheet.getDataRange().getValues();
    const studentData = studentSheet.getDataRange().getValues();
    
    // Process schools (skip header row)
    for (let i = 1; i < schoolData.length; i++) {
      const row = schoolData[i];
      const regId = row[0];
      if (regId) {
        registrations[regId] = {
          schoolName: row[1],
          schoolType: row[2],
          createdAt: row[10],
          updatedAt: row[11],
          status: row[12],
          teachers: [],
          students: []
        };
      }
    }
    
    // Process teachers (skip header row)
    for (let i = 1; i < teacherData.length; i++) {
      const row = teacherData[i];
      const regId = row[0];
      if (regId && registrations[regId]) {
        registrations[regId].teachers.push({
          name: row[2],
          email: row[3],
          phone: row[4],
          position: row[5],
          order: row[6]
        });
      }
    }
    
    // Process students (skip header row)
    for (let i = 1; i < studentData.length; i++) {
      const row = studentData[i];
      const regId = row[0];
      if (regId && registrations[regId]) {
        registrations[regId].students.push({
          name: row[2],
          ic: row[3],
          gender: row[4],
          category: row[5],
          categoryDisplay: row[6],
          race: row[7],
          playerId: row[8]
        });
      }
    }
    
    return { registrations: registrations };
    
  } catch (error) {
    return { error: 'Failed to load data: ' + error.toString() };
  }
}

function saveRegistration(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const teacherSheet = ss.getSheetByName('GURU');
    const schoolSheet = ss.getSheetByName('SEKOLAH');
    const studentSheet = ss.getSheetByName('PELAJAR');
    
    const regId = data.registrationId;
    const isUpdate = data.action === 'update';
    
    // For updates, preserve original creation date
    let createdDate, updatedDate;
    if (isUpdate && data.originalCreatedAt) {
      createdDate = new Date(data.originalCreatedAt);
      updatedDate = new Date(data.updateTimestamp);
    } else {
      // New registration - both dates are the same
      createdDate = updatedDate = new Date(data.timestamp || new Date());
    }
    
    // Determine school type
    const schoolName = data.schoolName.toUpperCase();
    let schoolType = 'LAIN-LAIN';
    if (schoolName.includes('SK ')) schoolType = 'SEKOLAH KEBANGSAAN';
    else if (schoolName.includes('SMK ')) schoolType = 'SEKOLAH MENENGAH KEBANGSAAN';
    else if (schoolName.includes('SJKC ')) schoolType = 'SEKOLAH JENIS KEBANGSAAN (CINA)';
    else if (schoolName.includes('SJKT ')) schoolType = 'SEKOLAH JENIS KEBANGSAAN (TAMIL)';
    else if (schoolName.includes('SMKA ')) schoolType = 'SEKOLAH MENENGAH KEBANGSAAN AGAMA';
    
    // Calculate statistics
    const totalTeachers = data.teachers.length;
    const totalStudents = data.students.length;
    let totalMale = 0, totalFemale = 0;
    let totalU12 = 0, totalU15 = 0, totalU18 = 0;
    
    data.students.forEach(student => {
      if (student.gender === 'Lelaki') totalMale++;
      else totalFemale++;
      
      if (student.category.includes('12')) totalU12++;
      else if (student.category.includes('15')) totalU15++;
      else if (student.category.includes('18')) totalU18++;
    });
    
    // Clear existing data for this registration
    [teacherSheet, schoolSheet, studentSheet].forEach(sheet => {
      const sheetData = sheet.getDataRange().getValues();
      for (let i = sheetData.length - 1; i >= 1; i--) {
        if (sheetData[i][0] === regId) {
          sheet.deleteRow(i + 1);
        }
      }
    });
    
    // Save school data - preserve original creation date for updates
    schoolSheet.appendRow([
      regId, data.schoolName, schoolType, totalTeachers, totalStudents,
      totalMale, totalFemale, totalU12, totalU15, totalU18,
      createdDate, updatedDate, 'AKTIF'
    ]);
    
    // Save teachers - preserve original creation date for updates
    data.teachers.forEach((teacher, index) => {
      const position = index === 0 ? 'KETUA' : 'PENGIRING';
      const order = index + 1;
      
      teacherSheet.appendRow([
        regId, data.schoolName, teacher.name, teacher.email, teacher.phone,
        position, order, createdDate, updatedDate, 'AKTIF'
      ]);
    });
    
    // Save students - preserve original creation date for updates
    const headTeacher = data.teachers[0];
    data.students.forEach(student => {
      // Generate category display (L12, P15, etc.)
      const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
      const ageCode = student.category.includes('12') ? '12' : 
                     student.category.includes('15') ? '15' : '18';
      const categoryDisplay = genderCode + ageCode;
      
      studentSheet.appendRow([
        regId, data.schoolName, student.name, student.ic, student.gender,
        student.category, categoryDisplay, student.race, student.playerId,
        headTeacher.name, headTeacher.phone, createdDate, updatedDate, 'AKTIF'
      ]);
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: true, registrationId: regId }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function searchRegistration(regId, password) {
  try {
    const registrations = loadRegistrations();
    
    if (registrations.error) {
      return { found: false, error: registrations.error };
    }
    
    const registration = registrations.registrations[regId];
    if (!registration) {
      return { found: false, error: 'Registration not found' };
    }
    
    // Verify password (last 4 digits of first teacher's phone)
    if (registration.teachers.length > 0) {
      const phone = registration.teachers[0].phone.replace(/\\D/g, '');
      const last4 = phone.slice(-4);
      
      if (last4 === password) {
        return { found: true, registration: registration };
      }
    }
    
    return { found: false, error: 'Invalid password' };
    
  } catch (error) {
    return { found: false, error: error.toString() };
  }
}`;

            document.getElementById('appsScriptCode').textContent = scriptTemplate;
        }

        function testCurrentConnection() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = 'Testing...';
            statusEl.className = 'px-2 py-1 rounded text-xs bg-yellow-200 text-yellow-800';
            
            if (!GOOGLE_SCRIPT_URL) {
                statusEl.textContent = 'Not configured';
                statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                return;
            }
            
            // Test connection
            const callbackName = 'testCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                if (data && !data.error) {
                    statusEl.textContent = 'Connected âœ…';
                    statusEl.className = 'px-2 py-1 rounded text-xs bg-green-200 text-green-800';
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
                    statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                }
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=load&callback=' + callbackName;
            script.onerror = () => {
                statusEl.textContent = 'Connection failed âŒ';
                statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    statusEl.textContent = 'Timeout â°';
                    statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                }
            }, 10000);
        }

        function testGoogleSheetsConnection() {
            const testUrl = document.getElementById('webAppUrl').value;
            const resultEl = document.getElementById('testResult');
            
            if (!testUrl) {
                resultEl.innerHTML = '<div class="text-red-600">âŒ Please enter your Web App URL first</div>';
                return;
            }
            
            resultEl.innerHTML = '<div class="text-blue-600">ğŸ§ª Testing connection...</div>';
            
            const callbackName = 'testConnectionCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                if (data && !data.error) {
                    resultEl.innerHTML = '<div class="text-green-600">âœ… Connection successful! Found ' + (Object.keys(data.registrations || {}).length) + ' registrations.</div>';
                } else {
                    resultEl.innerHTML = '<div class="text-red-600">âŒ Connection failed: ' + (data.error || 'Unknown error') + '</div>';
                }
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            const script = document.createElement('script');
            script.src = testUrl + '?action=load&callback=' + callbackName;
            script.onerror = () => {
                resultEl.innerHTML = '<div class="text-red-600">âŒ Failed to load script. Check your URL and deployment settings.</div>';
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    resultEl.innerHTML = '<div class="text-red-600">ï¿½ï¿½ï¿½ Connection timeout. Check your script and try again.</div>';
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                }
            }, 15000);
        }

        function saveGoogleSheetsConfig() {
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            const webAppUrl = document.getElementById('webAppUrl').value;
            
            if (!spreadsheetId || !webAppUrl) {
                alert('Please fill in both Spreadsheet ID and Web App URL');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('spreadsheetId', spreadsheetId);
            localStorage.setItem('webAppUrl', webAppUrl);
            
            // Update the global variable
            GOOGLE_SCRIPT_URL = webAppUrl;
            
            // Show success message
            showSyncStatus('âœ… Configuration saved! You can now sync with Google Sheets.', 'success');
            
            // Close modal
            closeSetupModal();
            
            // Test the new configuration
            setTimeout(() => {
                loadFromGoogleSheets();
            }, 1000);
        }

        // Load saved configuration on page load
        function loadSavedConfig() {
            const savedWebAppUrl = localStorage.getItem('webAppUrl');
            if (savedWebAppUrl) {
                GOOGLE_SCRIPT_URL = savedWebAppUrl;
            }
            
            // Auto-configure with provided credentials if not already saved
            if (!localStorage.getItem('spreadsheetId')) {
                localStorage.setItem('spreadsheetId', '1FJnBiWM5cuH0a1Yw0CxAR9zy_LiD1lVtQg9ijXRrPS4');
            }
            if (!localStorage.getItem('webAppUrl')) {
                localStorage.setItem('webAppUrl', 'https://script.google.com/macros/s/AKfycbwWNUtbfV4VKvsmbGyD4RWNUEVFdKwkk8bOsXuPdBkfgJ_-QFySGx0uJmfsBW5087mlPQ/exec');
            }
        }

        // Initialize saved config
        loadSavedConfig();

        // Registration Update Functions
        async function searchRegistration(event) {
            event.preventDefault();
            
            const regId = document.getElementById('searchRegId').value.trim();
            const password = document.getElementById('searchPassword').value.trim();
            
            if (!regId || !password) {
                showNotification('âŒ Sila masukkan ID pendaftaran dan kata laluan', 'error');
                return;
            }
            
            const searchButton = document.getElementById('searchButton');
            const originalText = searchButton.innerHTML;
            searchButton.innerHTML = 'ğŸ” Mencari...';
            searchButton.disabled = true;
            
            try {
                // First check local storage
                let registration = null;
                if (registrations[regId]) {
                    const localReg = registrations[regId];
                    if (localReg.teachers && localReg.teachers.length > 0) {
                        const phone = localReg.teachers[0].phone.replace(/\D/g, '');
                        const last4 = phone.slice(-4);
                        
                        if (last4 === password) {
                            registration = localReg;
                            showNotification('âœ… Pendaftaran dijumpai dari data tempatan', 'success');
                        }
                    }
                }
                
                // If not found locally, search from Google Sheets
                if (!registration && GOOGLE_SCRIPT_URL) {
                    try {
                        const callbackName = 'searchCallback_' + Date.now();
                        
                        const searchPromise = new Promise((resolve, reject) => {
                            window[callbackName] = function(data) {
                                resolve(data);
                                delete window[callbackName];
                                if (script.parentNode) {
                                    document.head.removeChild(script);
                                }
                            };
                            
                            const script = document.createElement('script');
                            script.src = `${GOOGLE_SCRIPT_URL}?action=search&regId=${encodeURIComponent(regId)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
                            
                            script.onerror = () => {
                                reject(new Error('Failed to load script'));
                                delete window[callbackName];
                                if (script.parentNode) {
                                    document.head.removeChild(script);
                                }
                            };
                            
                            document.head.appendChild(script);
                            
                            setTimeout(() => {
                                if (window[callbackName]) {
                                    reject(new Error('Request timeout'));
                                    delete window[callbackName];
                                    if (script.parentNode) {
                                        document.head.removeChild(script);
                                    }
                                }
                            }, 10000);
                        });
                        
                        const result = await searchPromise;
                        
                        if (result.found && result.registration) {
                            registration = result.registration;
                            // Update local storage with found registration
                            registrations[regId] = registration;
                            localStorage.setItem('registrations', JSON.stringify(registrations));
                            showNotification('âœ… Pendaftaran dijumpai dari Google Sheets', 'success');
                        } else {
                            showNotification('âŒ ' + (result.error || 'Pendaftaran tidak dijumpai atau kata laluan salah'), 'error');
                        }
                    } catch (error) {
                        console.error('Search error:', error);
                        showNotification('âŒ Ralat mencari dari Google Sheets: ' + error.message, 'error');
                    }
                }
                
                if (registration) {
                    populateEditForm(regId, registration);
                    document.getElementById('searchForm').style.display = 'none';
                    document.getElementById('editForm').classList.remove('hidden');
                } else if (!GOOGLE_SCRIPT_URL) {
                    showNotification('âŒ Pendaftaran tidak dijumpai dalam data tempatan', 'error');
                } else {
                    showNotification('âŒ Pendaftaran tidak dijumpai atau kata laluan salah', 'error');
                }
                
            } catch (error) {
                console.error('Search error:', error);
                showNotification('âŒ Ralat mencari pendaftaran: ' + error.message, 'error');
            } finally {
                searchButton.innerHTML = originalText;
                searchButton.disabled = false;
            }
        }

        function populateEditForm(regId, registration) {
            currentEditData = { regId, registration };
            
            // Set hidden fields
            document.getElementById('editRegId').value = regId;
            document.getElementById('originalCreatedAt').value = registration.createdAt || new Date().toISOString();
            
            // Populate school name and type
            document.getElementById('editSchoolName').value = registration.schoolName || '';
            document.getElementById('editSchoolType').value = registration.schoolType || '';
            
            // Populate teachers
            const teachersContainer = document.getElementById('editTeachersContainer');
            teachersContainer.innerHTML = '';
            editTeacherCount = 0;
            
            if (registration.teachers && registration.teachers.length > 0) {
                registration.teachers.forEach((teacher, index) => {
                    addEditTeacherWithData(teacher, index);
                });
            } else {
                addEditTeacher(); // Add at least one teacher
            }
            
            // Populate students
            const studentsContainer = document.getElementById('editStudentsContainer');
            studentsContainer.innerHTML = '';
            editStudentCount = 0;
            
            if (registration.students && registration.students.length > 0) {
                registration.students.forEach((student, index) => {
                    addEditStudentWithData(student, index);
                });
            } else {
                addEditStudent(); // Add at least one student
            }
        }

        function addEditTeacherWithData(teacherData = null, index = null) {
            const container = document.getElementById('editTeachersContainer');
            const teacherIndex = index !== null ? index : editTeacherCount;
            const newTeacher = document.createElement('div');
            newTeacher.className = 'edit-teacher-entry bg-orange-50 p-4 rounded-lg mb-4';
            newTeacher.setAttribute('data-edit-teacher-index', teacherIndex);
            
            const isFirst = teacherIndex === 0;
            const position = isFirst ? 'Ketua' : 'Pengiring';
            
            newTeacher.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Guru ${teacherIndex + 1} (${position}) ${isFirst ? '*' : ''}</h4>
                    ${!isFirst ? `<button type="button" onclick="removeEditTeacher(${teacherIndex})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">ğŸ—‘ï¸ Buang</button>` : ''}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                        <input type="text" required class="edit-teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru" value="${teacherData ? teacherData.name || '' : ''}">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                        <input type="email" required class="edit-teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com" value="${teacherData ? teacherData.email || '' : ''}">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                        <input type="tel" required class="edit-teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13" value="${teacherData ? teacherData.phone || '' : ''}">
                    </div>
                </div>
            `;
            
            container.appendChild(newTeacher);
            if (index === null) editTeacherCount++;
        }

        function addEditStudentWithData(studentData = null, index = null) {
            const container = document.getElementById('editStudentsContainer');
            const studentIndex = index !== null ? index : editStudentCount;
            const newStudent = document.createElement('div');
            newStudent.className = 'edit-student-entry bg-orange-50 p-4 rounded-lg mb-4';
            newStudent.setAttribute('data-edit-student-index', studentIndex);
            
            newStudent.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Pelajar ${studentIndex + 1}</h4>
                    <button type="button" onclick="removeEditStudent(${studentIndex})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">ğŸ—‘ï¸ Buang</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                        <input type="text" required class="edit-student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar" value="${studentData ? studentData.name || '' : ''}">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                        <input type="text" required class="edit-student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14" value="${studentData ? studentData.ic || '' : ''}">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Bangsa *</label>
                        <select required class="edit-student-race w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Bangsa</option>
                            <option value="Melayu" ${studentData && studentData.race === 'Melayu' ? 'selected' : ''}>Melayu</option>
                            <option value="Cina" ${studentData && studentData.race === 'Cina' ? 'selected' : ''}>Cina</option>
                            <option value="India" ${studentData && studentData.race === 'India' ? 'selected' : ''}>India</option>
                            <option value="Bumiputera" ${studentData && studentData.race === 'Bumiputera' ? 'selected' : ''}>Bumiputera</option>
                            <option value="Lain-lain" ${studentData && studentData.race === 'Lain-lain' ? 'selected' : ''}>Lain-lain</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                        <select required class="edit-student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Jantina</option>
                            <option value="Lelaki" ${studentData && studentData.gender === 'Lelaki' ? 'selected' : ''}>Lelaki</option>
                            <option value="Perempuan" ${studentData && studentData.gender === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                        <select required class="edit-student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Kategori</option>
                            <option value="Bawah 12 Tahun" ${studentData && studentData.category === 'Bawah 12 Tahun' ? 'selected' : ''}>Bawah 12 Tahun</option>
                            <option value="Bawah 15 Tahun" ${studentData && studentData.category === 'Bawah 15 Tahun' ? 'selected' : ''}>Bawah 15 Tahun</option>
                            <option value="Bawah 18 Tahun" ${studentData && studentData.category === 'Bawah 18 Tahun' ? 'selected' : ''}>Bawah 18 Tahun</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                        <input type="text" readonly class="edit-student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated" value="${studentData ? studentData.playerId || '' : ''}">
                    </div>
                </div>
            `;
            
            container.appendChild(newStudent);
            if (index === null) editStudentCount++;
            
            // Update student IDs after adding
            updateEditStudentIds();
        }

        function addEditTeacher() {
            addEditTeacherWithData();
        }

        function addEditStudent() {
            addEditStudentWithData();
        }

        function removeEditTeacher(index) {
            const teachers = document.querySelectorAll('.edit-teacher-entry');
            if (teachers.length > 1 && index > 0) {
                const teacher = document.querySelector(`[data-edit-teacher-index="${index}"]`);
                if (teacher) teacher.remove();
            } else if (index === 0) {
                showNotification('Guru 1 (Ketua) tidak boleh dibuang!', 'error');
            } else {
                showNotification('Minimum 1 guru diperlukan!', 'error');
            }
        }

        function removeEditStudent(index) {
            const student = document.querySelector(`[data-edit-student-index="${index}"]`);
            if (student) {
                student.remove();
                updateEditStudentIds();
            }
        }

        function updateEditStudentIds() {
            const schoolName = document.getElementById('editSchoolName').value;
            const regId = document.getElementById('editRegId').value;
            const students = document.querySelectorAll('.edit-student-entry');
            
            students.forEach((student, index) => {
                const gender = student.querySelector('.edit-student-gender').value;
                const category = student.querySelector('.edit-student-category').value;
                const idField = student.querySelector('.edit-student-id');
                
                if (gender && schoolName && category && regId) {
                    idField.value = generatePlayerId(gender, schoolName, index, category, regId);
                }
            });
        }

        function clearSearch() {
            document.getElementById('searchRegId').value = '';
            document.getElementById('searchPassword').value = '';
            document.getElementById('searchForm').style.display = 'block';
            document.getElementById('editForm').classList.add('hidden');
            currentEditData = null;
        }

        function cancelEdit() {
            clearSearch();
        }

        async function handleUpdateSubmit(event) {
            event.preventDefault();
            
            const regId = document.getElementById('editRegId').value;
            const originalCreatedAt = document.getElementById('originalCreatedAt').value;
            
            // Collect updated data
            const schoolName = document.getElementById('editSchoolName').value;
            const schoolType = document.getElementById('editSchoolType').value;
            
            const teachers = [];
            document.querySelectorAll('.edit-teacher-entry').forEach((entry, index) => {
                teachers.push({
                    name: entry.querySelector('.edit-teacher-name').value,
                    email: entry.querySelector('.edit-teacher-email').value,
                    phone: entry.querySelector('.edit-teacher-phone').value,
                    position: index === 0 ? 'Ketua' : 'Pengiring'
                });
            });
            
            const students = [];
            document.querySelectorAll('.edit-student-entry').forEach((entry, index) => {
                const gender = entry.querySelector('.edit-student-gender').value;
                const category = entry.querySelector('.edit-student-category').value;
                
                let playerId = entry.querySelector('.edit-student-id').value;
                if (gender && category && schoolName) {
                    playerId = generatePlayerId(gender, schoolName, index, category, regId);
                }
                
                students.push({
                    name: entry.querySelector('.edit-student-name').value,
                    ic: entry.querySelector('.edit-student-ic').value,
                    gender: gender,
                    race: entry.querySelector('.edit-student-race').value,
                    category: category,
                    playerId: playerId
                });
            });
            
            const updateButton = document.getElementById('updateSubmitButton');
            const originalText = updateButton.innerHTML;
            updateButton.innerHTML = 'ğŸ’¾ Menyimpan...';
            updateButton.disabled = true;
            
            try {
                // Update local storage immediately
                const updatedData = {
                    schoolName: schoolName,
                    schoolType: schoolType,
                    teachers: teachers,
                    students: students,
                    createdAt: originalCreatedAt, // Keep original creation date
                    updatedAt: new Date().toISOString(), // Update modification date
                    status: 'AKTIF'
                };
                
                registrations[regId] = updatedData;
                localStorage.setItem('registrations', JSON.stringify(registrations));
                
                // Send to Google Sheets with update flag
                if (GOOGLE_SCRIPT_URL) {
                    try {
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'update',
                                registrationId: regId,
                                schoolName: schoolName,
                                schoolType: schoolType,
                                teachers: teachers,
                                students: students,
                                originalCreatedAt: originalCreatedAt,
                                updateTimestamp: new Date().toISOString()
                            })
                        });
                    } catch (error) {
                        console.error('Error updating Google Sheets:', error);
                    }
                }
                
                showNotification(`âœ… Kemaskini berjaya! ID Pendaftaran: ${regId}`, 'success');
                
                // Update dashboard
                updateDashboard();
                
                // Clear form and return to search
                clearSearch();
                
                // Refresh from Google Sheets in background
                setTimeout(() => {
                    loadFromGoogleSheets();
                }, 2000);
                
            } catch (error) {
                console.error('Update error:', error);
                showNotification('âŒ Ralat menyimpan kemaskini: ' + error.message, 'error');
            } finally {
                updateButton.innerHTML = originalText;
                updateButton.disabled = false;
            }
        }

        // Add event listeners for edit form formatting
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('edit-teacher-name') || e.target.classList.contains('edit-student-name')) {
                e.target.value = e.target.value.toUpperCase();
            }
            
            if (e.target.classList.contains('edit-teacher-phone')) {
                e.target.value = formatPhoneNumber(e.target.value);
            }
            
            if (e.target.classList.contains('edit-student-ic')) {
                e.target.value = formatIC(e.target.value);
            }
            
            if (e.target.classList.contains('edit-student-gender') || e.target.classList.contains('edit-student-category')) {
                updateEditStudentIds();
            }
            
            if (e.target.id === 'editSchoolName') {
                e.target.value = formatSchoolName(e.target.value);
                updateEditStudentIds();
            }
        });







        // Toggle schedule function
        function toggleSchedule(type) {
            const scheduleDiv = document.getElementById(type + 'Schedule');
            const arrow = document.getElementById(type + 'Arrow');
            
            if (scheduleDiv.classList.contains('hidden')) {
                scheduleDiv.classList.remove('hidden');
                arrow.textContent = 'â–²';
            } else {
                scheduleDiv.classList.add('hidden');
                arrow.textContent = 'â–¼';
            }
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c072b5a537ca852',t:'MTc2ODgzNDQ4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
